<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Moxie – Sign</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Load the Dropbox Sign embedded script once -->
    <script src="https://cdn.hellosign.com/public/js/hellosign-embedded.LATEST.min.js" defer></script>
    <style>
      html, body { height:100%; margin:0; background:#f6f8fb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
      #app { max-width: 920px; margin: 0 auto; padding: 16px; height: 100%; display: flex; flex-direction: column; }
      #container { flex: 1 1 auto; background:#fff; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; box-shadow: 0 8px 20px rgba(0,0,0,.04); }
      #msg { margin: 12px 0; color:#6b7280; }
      .hidden { display:none; }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="msg">Loading your document...</div>
      <div id="container"></div>
    </div>

    <script>
      window.addEventListener('DOMContentLoaded', async () => {
        // ======= CONFIG =======
        const CLIENT_ID = "f124d14e450e53a65cc02a69f4e6d12e";
        // Use your HTTPS backend (local dev via HTTPS or a tunnel)
        const SIGN_URL_ENDPOINT = "https://localhost:5043/api/dropboxsign/sign-url";
        // ======================

        const msgEl = document.getElementById('msg');
        const containerEl = document.getElementById('container');
        if (!msgEl || !containerEl) return;

        const qs = new URLSearchParams(location.search);
        const sigId = qs.get('sid');
        if (!sigId) { msgEl.textContent = "Missing `sid` (signature_id) in URL."; return; }

        // 1) Call Moxie API to get embedded signature request URL.
        let signUrl;
        try {
          const resp = await fetch(`${SIGN_URL_ENDPOINT}?sid=${encodeURIComponent(sigId)}`, { credentials: 'omit' });

          //debugging 
          const raw = await resp.text(); 
          console.log("sign-url raw response:", raw);
          
          if (!resp.ok) throw new Error(`Backend ${resp.status}: ${raw}`);
          
          const data = JSON.parse(raw);
          signUrl = data && data.signUrl;
          if (!signUrl) throw new Error("No signUrl in response JSON");
        } catch (e) {
          console.error(e);
          msgEl.textContent = 'Could not retrieve signing link. Please try again.';
          return;
        }

        // 2) Initialize & open embedded signing
        try {
          // NOTE: with this CDN build you don't "new" HelloSign — you init then open
          HelloSign.init(CLIENT_ID);

          HelloSign.open({
            url: signUrl,
            container: containerEl,
            //skipDomainVerification: true, // temp keep while using github.io (unverified)?
            messageListener: (evt) => console.log("HS event:", evt)
          });

          msgEl.classList.add('hidden');
        } catch (e) {
          console.error(e);
          msgEl.textContent = 'Could not open the signing session. Please refresh.';
        }
      });
    </script>
  </body>
</html>
